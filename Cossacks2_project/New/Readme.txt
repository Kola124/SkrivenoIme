Some code is copied from cossacks revamp